name: DevSecOps Autopilot

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
      - test-autopilot

permissions:
  contents: read
  pull-requests: write

jobs:
  autopilot:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- Secret scanning (Gitleaks) ---
      - name: Run gitleaks (secrets)
        id: gitleaks
        continue-on-error: true
        uses: gitleaks/gitleaks-action@v2
        with:
          args: >
            detect
            --no-git
            --redact
            --report-format json
            --report-path gitleaks.json

      # --- Dependency / filesystem vuln scanning (Trivy) ---
      - name: Run trivy (vulnerabilities)
        id: trivy
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          format: json
          output: trivy.json
          severity: CRITICAL,HIGH,MEDIUM,LOW
          ignore-unfixed: true

      - name: Summarize results
        id: summary
        run: |
          set -e

          # Defaults
          echo "secrets_found=false" >> $GITHUB_OUTPUT
          echo "high_or_critical=false" >> $GITHUB_OUTPUT
          echo "secrets_count=0" >> $GITHUB_OUTPUT
          echo "hc_vuln_count=0" >> $GITHUB_OUTPUT

          # Gitleaks count
          if [ -f gitleaks.json ]; then
            SECRETS_COUNT=$(python - <<'PY'
import json,sys
p="gitleaks.json"
try:
  data=json.load(open(p))
  # gitleaks may output a list of findings
  if isinstance(data, list):
    print(len(data))
  else:
    # fallback
    print(0)
except Exception:
  print(0)
PY
)
            echo "secrets_count=$SECRETS_COUNT" >> $GITHUB_OUTPUT
            if [ "$SECRETS_COUNT" -gt 0 ]; then
              echo "secrets_found=true" >> $GITHUB_OUTPUT
            fi
          fi

          # Trivy HIGH/CRITICAL vuln count
          if [ -f trivy.json ]; then
            HC_COUNT=$(python - <<'PY'
import json
p="trivy.json"
data=json.load(open(p))
count=0
for r in data.get("Results", []):
  for v in r.get("Vulnerabilities", []) or []:
    sev=(v.get("Severity") or "").upper()
    if sev in ("HIGH","CRITICAL"):
      count += 1
print(count)
PY
)
            echo "hc_vuln_count=$HC_COUNT" >> $GITHUB_OUTPUT
            if [ "$HC_COUNT" -gt 0 ]; then
              echo "high_or_critical=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create/Update ONE PR comment (no noise)
        uses: actions/github-script@v7
        env:
          SECRETS_FOUND: ${{ steps.summary.outputs.secrets_found }}
          HIGH_OR_CRITICAL: ${{ steps.summary.outputs.high_or_critical }}
          SECRETS_COUNT: ${{ steps.summary.outputs.secrets_count }}
          HC_VULN_COUNT: ${{ steps.summary.outputs.hc_vuln_count }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.issue.number;

            const marker = "<!-- autopilot-report -->";
            const secretsFound = process.env.SECRETS_FOUND === "true";
            const highOrCritical = process.env.HIGH_OR_CRITICAL === "true";
            const secretsCount = Number(process.env.SECRETS_COUNT || 0);
            const hcVulnCount = Number(process.env.HC_VULN_COUNT || 0);

            const status = (secretsFound || highOrCritical) ? "❌ Blocked" : "✅ Clear";
            const headline = `## DevSecOps Autopilot Report ${status}`;

            const bullets = [
              `- **Secrets (gitleaks):** ${secretsFound ? `❌ ${secretsCount} finding(s)` : "✅ none found"}`,
              `- **Vulnerabilities (trivy):** ${highOrCritical ? `❌ ${hcVulnCount} HIGH/CRITICAL` : "✅ no HIGH/CRITICAL"}`
            ].join("\n");

            const guidance = (secretsFound || highOrCritical)
              ? "\n### What to do next\n- Remove secrets / rotate keys\n- Patch or upgrade vulnerable deps\n- Push a fix commit — Autopilot will re-run and update this comment."
              : "\n### Next\n- Looks good. Safe to merge from a security standpoint.";

            const body = `${marker}\n${headline}\n\n${bullets}\n${guidance}\n\n<sub>Autopilot updates this single comment on every PR update to avoid noise.</sub>`;

            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const existing = comments.find(c => c.body && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }

      - name: Gate merge (fail job if blocked)
        if: ${{ steps.summary.outputs.secrets_found == 'true' || steps.summary.outputs.high_or_critical == 'true' }}
        run: |
          echo "Autopilot blocked this PR due to secrets and/or HIGH/CRITICAL vulnerabilities."
          exit 1
          
