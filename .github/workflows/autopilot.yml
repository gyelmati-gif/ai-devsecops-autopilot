# =============================================================================
# AI DevSecOps Autopilot â€” Minimal Guaranteed Workflow
# =============================================================================
# STEP 1: Replace your current .github/workflows/autopilot.yml with this file
#         on BOTH the main branch AND your PR branch (test-autopilot).
#
# CRITICAL RULES TO AVOID "no jobs":
#   - "on:", "jobs:", and job keys MUST be at column 0 (no leading spaces)
#   - Use spaces only, NEVER tabs
#   - The file on the PR branch is what GitHub reads for push events
#   - The merge-base version is what GitHub reads for pull_request events
# =============================================================================

name: AI DevSecOps Autopilot

# --- Triggers ---
# pull_request: fires when PR is opened/updated against main
# No push trigger needed â€” pull_request is sufficient for PR checks.
# Adding push with branch filters can cause the "no jobs" ghost runs.
on:
  pull_request:
    branches:
      - main

# --- Permissions ---
# Explicitly set so the PR comment step can write to the pull request.
permissions:
  contents: read
  pull-requests: write

# --- Jobs ---
jobs:
  # =========================================================================
  # Phase 1: Minimal smoke test â€” proves the workflow runs and posts a check.
  # Once you see this green in PR Checks, we layer in gitleaks + trivy.
  # =========================================================================
  autopilot:
    name: "DevSecOps Autopilot"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Smoke test â€” prove the job runs
        run: |
          echo "============================================"
          echo " Autopilot workflow is running!"
          echo " Event:  ${{ github.event_name }}"
          echo " Branch: ${{ github.head_ref }}"
          echo " PR:     #${{ github.event.pull_request.number }}"
          echo " SHA:    ${{ github.sha }}"
          echo "============================================"
          echo "If you see this, the 'no jobs' problem is fixed."

      - name: Post PR comment (proof of life)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: devsecops-autopilot
          message: |
            ## ðŸ›¡ï¸ DevSecOps Autopilot â€” Smoke Test

            âœ… **Workflow executed successfully!**

            | Detail | Value |
            |--------|-------|
            | Event | `${{ github.event_name }}` |
            | Branch | `${{ github.head_ref }}` |
            | Commit | `${{ github.sha }}` |

            > This comment will be replaced with real scan results once gitleaks + trivy are added.
